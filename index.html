<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Karma Delta Tracker</title>
  <style>
    body {
      background: #121212;
      color: #f1f1f1;
      font-family: Arial, sans-serif;
      padding: 1rem;
    }
    h1 {
      color: #4CAF50;
    }
    .loader {
      margin: 1rem 0;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #333;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background: #1e1e1e;
    }
    tr:nth-child(even) {
      background: #1a1a1a;
    }
    .success {
      color: #4CAF50;
    }
    .fail {
      color: #f44336;
    }
  </style>
</head>
<body>
  <h1>Karma Delta Tracker (Active Players Only)</h1>
  <div class="loader" id="loader">Loading... Success: 0 | Fail: 0</div>
  <table id="karmaTable">
    <thead>
      <tr>
        <th>Username</th>
        <th>User ID</th>
        <th>Karma Delta</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const rostersUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRe5WoA--wsfCCCvtL8QgQKsJv0z1AIUTY7k5NEYgUF-Ipu3Iotxkcbw7D-Cme6YGUksHy3DmyDYpaO/pub?output=csv';
    const scheduleUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRgy7uZ8caLI4hTPKSjl9e7ztFaM9vdBk4vXDQbPtcybqzXGOm3FMpSJiyrRTzIM3K70z_6XbgBGP_0/pub?output=csv';
    const tableBody = document.querySelector('#karmaTable tbody');
    const loader = document.getElementById('loader');

    let successCount = 0;
    let failCount = 0;

    async function fetchCSV(url) {
      const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
      const text = await res.text();
      return text.trim().split('\n').map(row =>
        row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/g).map(col => col.replace(/^"|"$/g, ''))
      );
    }

    async function fetchData() {
      const [rosters, schedule] = await Promise.all([
        fetchCSV(rostersUrl),
        fetchCSV(scheduleUrl)
      ]);

      const rosterHeaders = rosters.shift();
      const scheduleHeaders = schedule.shift();

      const userIndex = rosterHeaders.findIndex(h => h.includes('User @'));
      const idIndex = rosterHeaders.findIndex(h => h.includes('User ID'));
      const teamIndex = rosterHeaders.findIndex(h => h.toLowerCase() === 'team');
      const playingIndex = rosterHeaders.findIndex(h => h.toLowerCase().includes('playing'));

      const dateIndex = scheduleHeaders.findIndex(h => h.toLowerCase() === 'date');
      const team1Index = scheduleHeaders.findIndex(h => h.toLowerCase().includes('team 1'));
      const team2Index = scheduleHeaders.findIndex(h => h.toLowerCase().includes('team 2'));

      const today = new Date();
      const todayStr = `${today.getMonth() + 1}/${today.getDate()}`; // "7/8"

      const teamsPlayingToday = new Set(
        schedule
          .filter(row => row[dateIndex] === todayStr)
          .flatMap(row => [row[team1Index], row[team2Index].trim()])
      );

      const activeUsers = rosters.filter(row =>
        row[playingIndex]?.toLowerCase() === 'yes' &&
        teamsPlayingToday.has(row[teamIndex])
      ).map(row => ({
        username: row[userIndex],
        userId: row[idIndex]
      }));

      for (let i = 0; i < activeUsers.length; i += 5) {
        const batch = activeUsers.slice(i, i + 5);
        await Promise.all(batch.map(u => fetchKarmaWithRetry(u)));
        await new Promise(res => setTimeout(res, 800)); // Delay
      }
    }

    async function fetchKarmaWithRetry(user, tries = 0) {
      const maxRetries = 2;
      const proxies = [
        'https://api.allorigins.win/raw?url=',
        'https://api.allorigins.hex.pm/raw?url='
      ];

      for (let proxy of proxies) {
        try {
          const res = await fetch(`${proxy}${encodeURIComponent(`https://api.real.vg/user/${user.userId}/karmafeed`)}`);
          const data = await res.json();
          const delta = data.stats?.karmaDelta ?? 'N/A';

          successCount++;
          updateLoader();
          addRow(user.username, user.userId, delta, '✅', 'success');
          return;
        } catch (err) {
          continue;
        }
      }

      if (tries < maxRetries) {
        return fetchKarmaWithRetry(user, tries + 1);
      } else {
        failCount++;
        updateLoader();
        addRow(user.username, user.userId, 'Error', '❌', 'fail');
      }
    }

    function updateLoader() {
      loader.textContent = `Loading... Success: ${successCount} | Fail: ${failCount}`;
    }

    function addRow(username, userId, karmaDelta, status, statusClass) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${username}</td>
        <td>${userId}</td>
        <td>${karmaDelta}</td>
        <td class="${statusClass}">${status}</td>
      `;
      tableBody.appendChild(row);
    }

    fetchData();
  </script>
</body>
</html>
