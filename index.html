<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Karma Delta Tracker</title>
  <style>
    body {
      background: #121212;
      color: #f1f1f1;
      font-family: Arial, sans-serif;
      padding: 1rem;
    }
    h1 {
      color: #4CAF50;
    }
    .loader {
      margin: 1rem 0;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      border: 1px solid #333;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background: #1e1e1e;
    }
    tr:nth-child(even) {
      background: #1a1a1a;
    }
    .success {
      color: #4CAF50;
    }
    .fail {
      color: #f44336;
    }
  </style>
</head>
<body>
  <h1>Karma Delta Tracker</h1>
  <div class="loader" id="loader">Loading... Success: 0 | Fail: 0</div>
  <table id="karmaTable">
    <thead>
      <tr>
        <th>Username</th>
        <th>User ID</th>
        <th>Karma Delta</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRe5WoA--wsfCCCvtL8QgQKsJv0z1AIUTY7k5NEYgUF-Ipu3Iotxkcbw7D-Cme6YGUksHy3DmyDYpaO/pub?output=csv';
    const tableBody = document.querySelector('#karmaTable tbody');
    const loader = document.getElementById('loader');

    let successCount = 0;
    let failCount = 0;

    async function fetchCSVAndProcess() {
      const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`);
      const text = await res.text();
      const lines = text.trim().split('\n');
      const headers = lines.shift().split(',');

      const userIndex = headers.indexOf('User @');
      const idIndex = headers.indexOf('User ID');

      const users = lines.map(line => {
        const cols = line.split(',');
        return {
          username: cols[userIndex],
          userId: cols[idIndex]
        };
      });

      // Process in chunks of 5
      for (let i = 0; i < users.length; i += 5) {
        const batch = users.slice(i, i + 5);
        await Promise.all(batch.map(u => fetchKarma(u)));
        await new Promise(res => setTimeout(res, 350)); // 350ms delay between batches
      }
    }

    async function fetchKarma({ username, userId }) {
      const url = `https://api.real.vg/user/${userId}/karmafeed`;
      try {
        const res = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`);
        const data = await res.json();
        const karmaDelta = data.stats?.karmaDelta ?? 'N/A';

        successCount++;
        updateLoader();
        addRow(username, userId, karmaDelta, '✅', 'success');
      } catch (e) {
        failCount++;
        updateLoader();
        addRow(username, userId, 'Error', '❌', 'fail');
      }
    }

    function updateLoader() {
      loader.textContent = `Loading... Success: ${successCount} | Fail: ${failCount}`;
    }

    function addRow(username, userId, karmaDelta, status, statusClass) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${username}</td>
        <td>${userId}</td>
        <td>${karmaDelta}</td>
        <td class="${statusClass}">${status}</td>
      `;
      tableBody.appendChild(row);
    }

    fetchCSVAndProcess();
  </script>
</body>
</html>
